name: CI/CD for DigitalOcean

on:
  push:
    branches:
      - 'digitalOcean'
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SSH: ${{ secrets.DIGITALOCEAN_SSH_KEY}}
      USER: ${{ secrets.DIGITALOCEAN_DROPLET_USER }}
      IP: ${{ secrets.DIGITALOCEAN_DROPLET_IP }}

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'
      - name: Build Common
        run: mvn clean install
        working-directory: ./Common
      - name: Build GYM
        run: mvn clean install -Dspring.profiles.active=GitHubActions
        working-directory: ./GymService
        env:
          ACTIVEMQ_PASSWORD: ${{ secrets.ACTIVEMQ_PASSWORD }}
          ACTIVEMQ_URL: ${{ secrets.ACTIVEMQ_URL }}
          ACTIVEMQ_USERNAME: ${{ secrets.ACTIVEMQ_USERNAME }}
          DATABASE_HOST: ${{ secrets.DATABASE_HOST }}
          DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          DATABASE_PORT: ${{ secrets.DATABASE_PORT }}
          DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY}}
          GYM_PORT: ${{ secrets.GYM_PORT}}
      - name: Build REPORT
        run: mvn clean install -Dspring.profiles.active=GitHubActions
        working-directory: ./ReportService
        env:
          ACTIVEMQ_PASSWORD: ${{ secrets.ACTIVEMQ_PASSWORD }}
          ACTIVEMQ_URL: ${{ secrets.ACTIVEMQ_URL }}
          ACTIVEMQ_USERNAME: ${{ secrets.ACTIVEMQ_USERNAME }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY}}
          REPORT_PORT: ${{ secrets.REPORT_PORT}}
      - name: Prepare packeges for DigitalOcean
        run: |
          mkdir -p ~/app/
          cp -r ./GymService/target/GymService*.jar ~/app
          cp -r ./ReportService/target/ReportService*.jar ~/app
          cp -r ./run.sh ~/app
          cp -r ./docker-compose.yml ~/app
          cp -r ./DockerfileGymService ~/app
          cp -r ./DockerfileReportService ~/app
          cp -r ./GymService/src/main/resources/db/changelog/db.changelog-master.yaml ~/app
      - name: Copy files to DigitalOcean
        run: |
          mkdir -p ~/.ssh/
          echo "$SSH" > ~/.ssh/private.key
          sudo chmod 600 ~/.ssh/private.key
          ssh-keyscan -H $IP >> ~/.ssh/known_hosts
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/private.key
          scp -r ~/app $USER@$IP:~/
        shell: bash
      - name: Set environment variables on DigitalOcean
        run: |
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/private.key
          ssh $USER@$IP "echo -e '
          DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
          DATABASE_NAME=${{ secrets.DATABASE_NAME }}
          DATABASE_PORT=${{ secrets.DATABASE_PORT }}
          DATABASE_HOST=${{ secrets.DATABASE_HOST }}
          GYM_PORT=${{ secrets.GYM_PORT }}
          REPORT_PORT=${{ secrets.REPORT_PORT }}
          ACTIVEMQ_PORT_JMS=${{ secrets.ACTIVEMQ_PORT_JMS }}
          ACTIVEMQ_PORT=${{ secrets.ACTIVEMQ_PORT }}
          MONGO_PORT=${{ secrets.MONGO_PORT }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          ' > ~/app/.env"
      - name: Start application
        run: |
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/private.key
          ssh $USER@$IP "cd ~/app && docker compose build && docker compose up -d"